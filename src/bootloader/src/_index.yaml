version: "1.0"
namespace: wippy.bootloader

entries:
  # Requirements
  - name: application_host
    kind: ns.requirement
    meta:
      description: "Host ID for the application processes"
    targets:
      - entry: bootloader.service
        path: ".host"

  - name: env_storage
    kind: ns.requirement
    meta:
      description: "Environment storage for ENCRYPTION_KEY"
    targets:
      - entry: wippy.bootloader.bootloaders:encryption_key_var
        path: ".storage"
    default: "app.env:file"

  # wippy.bootloader:bootloader_registry
  - name: bootloader_registry
    kind: library.lua
    meta:
      comment: Registry for bootloader discovery
    source: file://bootloader_registry.lua
    imports:
      registry: :registry

  # wippy.bootloader:bootloader
  - name: bootloader
    kind: process.lua
    meta:
      comment: Main bootloader orchestrator
    source: file://bootloader.lua
    modules:
      - time
      - json
      - logger
      - funcs
    imports:
      bootloader_registry: wippy.bootloader:bootloader_registry
      registry: :registry
    method: run

  # wippy.bootloader:bootloader.service
  - name: bootloader.service
    kind: process.service
    meta:
      comment: Bootloader service with auto-start
    host: app:processes
    lifecycle:
      auto_start: true
      restart:
        initial_delay: 1s
      security:
        groups:
          - wippy.security:process
    process: bootloader

